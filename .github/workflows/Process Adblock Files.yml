name: Process Adblock Files

on:
  push:
    paths:
      - 'adblock_reject_egern.yaml'
      - 'adblock_reject_egern.txt'
  workflow_dispatch:

jobs:
  process-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Process files
        run: |
          import re

          def process_file(input_file, output_file):
              with open(input_file, 'r') as f:
                  lines = f.readlines()

              processed_lines = []
              payload_found = False

              for line in lines:
                  if line.strip().lower() == 'payload:':
                      payload_found = True
                      continue
                  if not payload_found:
                      continue
                  if line.strip().startswith('#'):
                      processed_lines.append(line)
                  else:
                      line = line.strip().lstrip('- ')
                      if line:
                          processed_lines.append(f"{line},REJECT\n")

              with open(output_file, 'w') as f:
                  f.writelines(processed_lines)

          process_file('adblock_reject_egern.yaml', 'adblock_reject_egern_module.yaml')
          process_file('adblock_reject_egern.txt', 'adblock_reject_egern_module.txt')
        shell: python

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add adblock_reject_egern_module.yaml adblock_reject_egern_module.txt
          git commit -m "Process adblock files" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
